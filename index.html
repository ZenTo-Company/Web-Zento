<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Viewer</title></head>
<body>
<h2>ðŸ“º Viewer</h2>
<video id="remote" autoplay playsinline></video>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC0VGoxSAetZsT4pL8_Lu5yQQJqWz6TtDs",
  authDomain: "hc-iot.firebaseapp.com",
  databaseURL: "https://hc-iot.firebaseio.com",
  projectId: "hc-iot",
  storageBucket: "hc-iot.firebasestorage.app",
  messagingSenderId: "117718755722",
  appId: "1:117718755722:web:aa2c90d996732a941d4073",
  measurementId: "G-3839TLTQNE"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const iceServers = [
  {
    urls: [
      "stun:hk-turn1.xirsys.com",
      "turn:hk-turn1.xirsys.com:80?transport=udp",
      "turn:hk-turn1.xirsys.com:3478?transport=udp",
      "turns:hk-turn1.xirsys.com:80?transport=tcp"
      "turn:hk-turn1.xirsys.com:3478?transport=tcp",
      "turns:hk-turn1.xirsys.com:443?transport=tcp",
      "turns:hk-turn1.xirsys.com:5349?transport=tcp",
    ],
    username: "KUtzWkclpPdSjRhQZkEXse0Vt7bOcESgrWcrpmKdvUpCy6SumdMC1ROfbv7xxKJfAAAAAGjia8NOZ29IdXVDb25n",
    credential: "2bbc7df2-a1eb-11f0-aa13-0242ac120004"
  }
];

const pc = new RTCPeerConnection({ iceServers });
const remoteVideo = document.getElementById("remote");

pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; };

// Khi cÃ³ offer tá»« sender
onValue(ref(db, "offer"), async snapshot => {
  const offer = snapshot.val();
  if (offer) {
    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    set(ref(db, "answer"), answer);
  }
});

// Xá»­ lÃ½ ICE candidate
pc.onicecandidate = e => {
  if (e.candidate) set(ref(db, "candidate_viewer"), e.candidate.toJSON());
};

onValue(ref(db, "candidate_sender"), async snapshot => {
  const c = snapshot.val();
  if (c) await pc.addIceCandidate(c);
});
</script>
</body>
</html>
