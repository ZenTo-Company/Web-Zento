

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>WebRTC Firebase + Xirsys</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      text-align: center;
      padding: 20px;
    }
    video {
      width: 45%;
      border-radius: 10px;
      margin: 10px;
      background: black;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h2>ğŸ”¥ Truyá»n & Nháº­n video (Firebase + Xirsys)</h2>
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video><br>

  <button id="startButton">ğŸ¥ Báº¯t Ä‘áº§u truyá»n</button>
  <button id="receiveButton">ğŸ‘ Nháº­n video</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ğŸ”¥ 1. Cáº¥u hÃ¬nh Firebase â€” thay báº±ng cáº¥u hÃ¬nh tháº­t cá»§a báº¡n
    const firebaseConfig = {
  apiKey: "AIzaSyAkbjw_2bMSdup42uRB1wi8TQrGqJCQ-l0",
  authDomain: "hc-iot-dbf11.firebaseapp.com",
  projectId: "hc-iot-dbf11",
  storageBucket: "hc-iot-dbf11.firebasestorage.app",
  messagingSenderId: "172691277563",
  appId: "1:172691277563:web:f92eb0fda0bbb02d1b125e"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // â„ï¸ 2. Xirsys ICE servers (theo báº¡n cung cáº¥p)
    const iceServers = [
      { urls: [ "stun:hk-turn1.xirsys.com" ] },
      {
        username: "KUtzWkclpPdSjRhQZkEXse0Vt7bOcESgrWcrpmKdvUpCy6SumdMC1ROfbv7xxKJfAAAAAGjia8NOZ29IdXVDb25n",
        credential: "2bbc7df2-a1eb-11f0-aa13-0242ac120004",
        urls: [
          "turn:hk-turn1.xirsys.com:80?transport=udp",
          "turn:hk-turn1.xirsys.com:3478?transport=udp",
          "turn:hk-turn1.xirsys.com:80?transport=tcp",
          "turn:hk-turn1.xirsys.com:3478?transport=tcp",
          "turns:hk-turn1.xirsys.com:443?transport=tcp",
          "turns:hk-turn1.xirsys.com:5349?transport=tcp"
        ]
      }
    ];

    // 3. Biáº¿n toÃ n cá»¥c
    let pc;
    let localStream;
    const roomRef = db.ref("webrtc-room");

    // 4. Sá»± kiá»‡n nÃºt
    document.getElementById("startButton").onclick = startStreaming;
    document.getElementById("receiveButton").onclick = receiveStream;

    // ============================
    // ğŸ¥ Thiáº¿t bá»‹ gá»­i video
    // ============================
    async function startStreaming() {
      try {
        console.log("ğŸ¥ Má»Ÿ camera...");
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById("localVideo").srcObject = localStream;

        pc = new RTCPeerConnection({ iceServers });
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        // Gá»­i ICE candidate lÃªn Firebase
        pc.onicecandidate = event => {
          if (event.candidate) {
            roomRef.child("callerCandidates").push(event.candidate.toJSON());
          }
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await roomRef.child("offer").set(offer);
        console.log("âœ… Offer Ä‘Ã£ táº¡o vÃ  lÆ°u lÃªn Firebase");

        // Láº¯ng nghe answer tá»« thiáº¿t bá»‹ nháº­n
        roomRef.child("answer").on("value", async snapshot => {
          const answer = snapshot.val();
          if (answer && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
            console.log("ğŸ“¡ ÄÃ£ nháº­n answer tá»« thiáº¿t bá»‹ nháº­n");
          }
        });

        // Nháº­n ICE tá»« thiáº¿t bá»‹ nháº­n
        roomRef.child("calleeCandidates").on("child_added", snapshot => {
          const candidate = new RTCIceCandidate(snapshot.val());
          pc.addIceCandidate(candidate);
        });
      } catch (err) {
        console.error("Lá»—i khi má»Ÿ camera hoáº·c táº¡o káº¿t ná»‘i:", err);
        alert("âš ï¸ KhÃ´ng thá»ƒ truy cáº­p camera hoáº·c táº¡o káº¿t ná»‘i WebRTC!");
      }
    }

    // ============================
    // ğŸ‘ Thiáº¿t bá»‹ nháº­n video
    // ============================
    async function receiveStream() {
      try {
        console.log("ğŸ›° Chuáº©n bá»‹ nháº­n tÃ­n hiá»‡u...");
        pc = new RTCPeerConnection({ iceServers });

        pc.ontrack = event => {
          console.log("ğŸ“º Nháº­n Ä‘Æ°á»£c stream video!");
          document.getElementById("remoteVideo").srcObject = event.streams[0];
        };

        pc.onicecandidate = event => {
          if (event.candidate) {
            roomRef.child("calleeCandidates").push(event.candidate.toJSON());
          }
        };

        const offerSnapshot = await roomRef.child("offer").once("value");
        const offer = offerSnapshot.val();
        if (!offer) {
          alert("âš ï¸ ChÆ°a cÃ³ tÃ­n hiá»‡u tá»« ngÆ°á»i gá»­i!");
          return;
        }

        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await roomRef.child("answer").set(answer);
        console.log("âœ… ÄÃ£ gá»­i answer vá» Firebase");

        // Láº¯ng nghe ICE cá»§a caller
        roomRef.child("callerCandidates").on("child_added", snapshot => {
          const candidate = new RTCIceCandidate(snapshot.val());
          pc.addIceCandidate(candidate);
        });
      } catch (err) {
        console.error("Lá»—i khi nháº­n tÃ­n hiá»‡u:", err);
      }
    }
  </script>
</body>
</html>