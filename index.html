/*<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC Camera Stream - Firebase + Xirsys</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: sans-serif; background: #121212; color: white; text-align: center; }
    video { width: 90%; max-width: 480px; margin: 10px; border-radius: 8px; border: 2px solid #00bfff; }
    button { background: #00bfff; border: none; padding: 10px 20px; color: white; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>ğŸ“¡ PhÃ¡t video qua WebRTC (Firebase + Xirsys)</h2>
  <video id="localVideo" autoplay playsinline muted></video><br>
  <button id="startBtn">Báº¯t Ä‘áº§u phÃ¡t</button>

  <script>
    // --- ğŸ”¹ Cáº¥u hÃ¬nh Firebase ---
   const firebaseConfig = {
  apiKey: "AIzaSyAkbjw_2bMSdup42uRB1wi8TQrGqJCQ-l0",
  authDomain: "hc-iot-dbf11.firebaseapp.com",
  projectId: "hc-iot-dbf11",
  storageBucket: "hc-iot-dbf11.firebasestorage.app",
  messagingSenderId: "172691277563",
  appId: "1:172691277563:web:f92eb0fda0bbb02d1b125e"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- ğŸ”¹ Biáº¿n toÃ n cá»¥c ---
    const localVideo = document.getElementById('localVideo');
    const startBtn = document.getElementById('startBtn');
    const roomRef = db.ref('room1');

    let pc;

    // --- ğŸ”¹ HÃ m láº¥y ICE server tá»« Xirsys ---

async function getIceServers() {
  try {
    const response = await fetch("https://global.xirsys.net/_turn/Tx-video", {
      method: "PUT",
      headers: {
        "Authorization": "Basic " + btoa("NgoHuuCong:5f31e39e-a1ea-11f0-8c8f-0242ac130002"),
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ format: "urls" })
    });

    const data = await response.json();
    console.log("Xirsys response:", data);

    // Kiá»ƒm tra ká»¹ vÃ  tráº£ vá» Ä‘Ãºng máº£ng
    if (data && data.v && Array.isArray(data.v.iceServers)) {
      return data.v.iceServers;
    } else if (data.v && data.v.iceServers && typeof data.v.iceServers === "object") {
      return [data.v.iceServers];
    } else {
      console.warn("KhÃ´ng láº¥y Ä‘Æ°á»£c ICE servers, dÃ¹ng fallback STUN.");
      return [{ urls: "stun:stun.l.google.com:19302" }];
    }
  } catch (err) {
    console.error("Lá»—i khi láº¥y ICE servers:", err);
    return [{ urls: "stun:stun.l.google.com:19302" }];
  }
}




    
  /*  async function getIceServers() {
      const response = await fetch("https://global.xirsys.net/_turn/Tx-video", {
        method: "PUT",
        headers: {
          "Authorization": "Basic " + btoa("NgoHuuCong:5f31e39e-a1ea-11f0-8c8f-0242ac130002"),
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ format: "urls" })
      });
      const data = await response.json();
      return data.v.iceServers;
    }*/

    // --- ğŸ”¹ Báº¯t Ä‘áº§u truyá»n video ---
    startBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      localVideo.srcObject = stream;

      const iceServers = await getIceServers();
      pc = new RTCPeerConnection({ iceServers });

      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      pc.onicecandidate = event => {
        if (event.candidate) {
          db.ref("room1/callerCandidates").push(event.candidate.toJSON());
        }
      };

      // ğŸ”¹ Táº¡o offer
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await roomRef.set({ offer });

      // ğŸ”¹ Láº¯ng nghe answer tá»« viewer
      roomRef.child("answer").on("value", async snap => {
        const answer = snap.val();
        if (answer && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      // ğŸ”¹ ICE tá»« viewer
      roomRef.child("viewerCandidates").on("child_added", snap => {
        pc.addIceCandidate(new RTCIceCandidate(snap.val()));
      });

      alert("ğŸ“¤ Offer Ä‘Ã£ gá»­i lÃªn Firebase. Viewer cÃ³ thá»ƒ káº¿t ná»‘i!");
    };
  </script>
</body>
</html>
*/








<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebRTC Firebase + Xirsys</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f9f9f9; }
    video { width: 45%; margin: 10px; border-radius: 10px; background: black; }
    button { margin: 10px; padding: 10px 20px; }
  </style>
</head>
<body>
  <h2>ğŸ”¥ WebRTC truyá»n & nháº­n video (Firebase + Xirsys)</h2>
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video><br>

  <button id="startButton">ğŸ¥ Báº¯t Ä‘áº§u truyá»n</button>
  <button id="receiveButton">ğŸ‘ Nháº­n video</button>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // ğŸ”¥ Cáº¥u hÃ¬nh Firebase (thay báº±ng cáº¥u hÃ¬nh tháº­t cá»§a báº¡n)
    const firebaseConfig = {
  apiKey: "AIzaSyAkbjw_2bMSdup42uRB1wi8TQrGqJCQ-l0",
  authDomain: "hc-iot-dbf11.firebaseapp.com",
  projectId: "hc-iot-dbf11",
  storageBucket: "hc-iot-dbf11.firebasestorage.app",
  messagingSenderId: "172691277563",
  appId: "1:172691277563:web:f92eb0fda0bbb02d1b125e"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // â„ï¸ Xirsys ICE servers
    const iceServers = [
      { urls: "stun:stun.l.google.com:19302" },
      {
        urls: "turn:global.relay.xirsys.com:3478",
        username: "NgoHuuCong",
        credential: "5f31e39e-a1ea-11f0-8c8f-0242ac130002"
      }
    ];

    let pc;
    let localStream;
    const roomRef = db.ref("webrtc-room");

    document.getElementById("startButton").onclick = startStreaming;
    document.getElementById("receiveButton").onclick = receiveStream;

    // ğŸ“¸ 1. Thiáº¿t bá»‹ gá»­i video
    async function startStreaming() {
      console.log("ğŸ¥ Äang má»Ÿ camera...");
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("localVideo").srcObject = localStream;

      pc = new RTCPeerConnection({ iceServers });

      // ThÃªm luá»“ng video vÃ o PeerConnection
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // Khi cÃ³ candidate ICE thÃ¬ gá»­i lÃªn Firebase
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          roomRef.child("callerCandidates").push(event.candidate.toJSON());
        }
      };

      // Táº¡o offer vÃ  lÆ°u lÃªn Firebase
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await roomRef.child("offer").set(offer);
      console.log("âœ… Offer Ä‘Ã£ táº¡o vÃ  gá»­i lÃªn Firebase");

      // Láº¯ng nghe answer tá»« ngÆ°á»i nháº­n
      roomRef.child("answer").on("value", async snapshot => {
        const answer = snapshot.val();
        if (answer && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
          console.log("ğŸ“¡ ÄÃ£ nháº­n answer tá»« thiáº¿t bá»‹ nháº­n");
        }
      });

      // Nháº­n candidate tá»« thiáº¿t bá»‹ nháº­n
      roomRef.child("calleeCandidates").on("child_added", snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        pc.addIceCandidate(candidate);
      });
    }

    // ğŸ‘ 2. Thiáº¿t bá»‹ nháº­n video
    async function receiveStream() {
      console.log("ğŸ›° Äang chuáº©n bá»‹ nháº­n tÃ­n hiá»‡u...");
      pc = new RTCPeerConnection({ iceServers });

      pc.ontrack = (event) => {
        console.log("ğŸ“º ÄÃ£ nháº­n stream!");
        document.getElementById("remoteVideo").srcObject = event.streams[0];
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          roomRef.child("calleeCandidates").push(event.candidate.toJSON());
        }
      };

      const offerSnapshot = await roomRef.child("offer").once("value");
      const offer = offerSnapshot.val();
      if (!offer) {
        alert("âš ï¸ ChÆ°a cÃ³ tÃ­n hiá»‡u tá»« ngÆ°á»i gá»­i!");
        return;
      }

      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await roomRef.child("answer").set(answer);
      console.log("âœ… ÄÃ£ gá»­i answer vá» Firebase");

      roomRef.child("callerCandidates").on("child_added", snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        pc.addIceCandidate(candidate);
      });
    }
  </script>
</body>
</html>
