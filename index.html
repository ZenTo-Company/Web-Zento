<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>WebRTC + Firebase + Xirsys</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video { width: 45%; border: 2px solid #ccc; margin: 10px; border-radius: 10px; }
  </style>
</head>
<body>
  <h2>WebRTC Truyền hình ảnh (Firebase + Xirsys)</h2>
  <p id="roleLabel"></p>
  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ✅ Thay thông tin Firebase của bạn vào đây
  const firebaseConfig = { 
  apiKey : "AIzaSyAkbjw_2bMSdup42uRB1wi8TQrGqJCQ-l0" , 
  authDomain : "hc-iot-dbf11.firebaseapp.com" , 
  projectId : "hc-iot-dbf11" , 
  storageBucket : "hc-iot-dbf11.firebasestorage.app" , 
  messagingSenderId : "172691277563" , 
  appId : "1:172691277563:web:f92eb0fda0bbb02d1b125e" 
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ✅ Cấu hình Xirsys
    const XIRSYS_URL = "https://global.xirsys.net/_turn/Tx-video";
    const USERNAME = "KUtzWkclpPdSjRhQZkEXse0Vt7bOcESgrWcrpmKdvUpCy6SumdMC1ROfbv7xxKJfAAAAAGjia8NOZ29IdXVDb25n";
    const TOKEN = "2bbc7df2-a1eb-11f0-aa13-0242ac120004";

    const urlParams = new URLSearchParams(window.location.search);
    const role = urlParams.get("role") || "viewer";
    document.getElementById("roleLabel").textContent = "Chế độ: " + role.toUpperCase();

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    let pc, localStream;

    async function getIceServers() {
      const response = await fetch(XIRSYS_URL, {
        method: "PUT",
        headers: {
          "Authorization": "Basic " + btoa(USERNAME + ":" + TOKEN),
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ format: "urls" })
      });
      const data = await response.json();
      return data.v.iceServers;
    }

    async function init() {
      const iceServers = await getIceServers();
      pc = new RTCPeerConnection({ iceServers });

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          const ref = db.ref("candidates/" + role);
          ref.push(event.candidate.toJSON());
        }
      };

      pc.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      if (role === "sender") {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        localVideo.srcObject = localStream;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await db.ref("offer").set({ sdp: offer.sdp, type: offer.type });
      }

      if (role === "viewer") {
  const offerSnap = await db.ref("offer").once("value");
        const offer = offerSnap.val();
        if (!offer) return alert("Chưa có offer từ sender!");
        await pc.setRemoteDescription(new RTCSessionDescription(offer));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await db.ref("answer").set({ sdp: answer.sdp, type: answer.type });
      }

      // Lắng nghe answer từ viewer
      if (role === "sender") {
        db.ref("answer").on("value", async (snap) => {
          const ans = snap.val();
          if (ans && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(ans));
          }
        });
      }

      // Lắng nghe ICE candidate từ phía bên kia
      const otherRole = (role === "sender") ? "viewer" : "sender";
      db.ref("candidates/" + otherRole).on("child_added", async (snap) => {
        const data = snap.val();
        await pc.addIceCandidate(new RTCIceCandidate(data));
      });
    }

    init();
  </script>
</body>
</html>

